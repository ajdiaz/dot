# vim: ft=muttrc
# Configuration file for neomutt (not working with standard mutt!)

set folder           = ~/sys/mail
set alias_file       = ~/.mutt/aliases       # where to store aliases
set header_cache     = ~/.mutt/cache/headers # where to store headers
set message_cachedir = ~/.mutt/cache/bodies  # where to store bodies
set certificate_file = ~/.mutt/certificates  # where to store certs
set mailcap_path     = ~/.mutt/mailcap       # entries for filetypes
set tmpdir           = ~/.mutt/temp          # where to keep temp files
set signature        = ~/.mutt/signature     # my signature file
set sig_dashes = no      # no predend dashes
set sig_on_top = yes     # put signature before quoted
set wait_key   = no      # shut up, mutt
set mbox_type  = Maildir # mailbox type
set timeout    = 3       # idle time before scanning
set mail_check = 0       # minimum time between scans
set delete               # don't ask, just do
set quit                 # don't ask, just do!!
set beep_new             # bell on new mails
set pipe_decode          # strip headers and eval mimes when piping
set thorough_search      # strip headers and eval mimes before searching
set edit_headers         # I want to edit the message headers.
set sleep_time = 0

# command to perform addrlookup using notmuch
set query_command = "/home/ajdiaz/.mutt/abq '%s'"
set query_format = "%4c %t %-70.70a %-70.70n %?e?(%e)?"

bind editor <Tab> complete-query
unset help
unset mark_old           # read/new is good enough for me
unset confirmappend      # don't ask, just do!

# status char format for %r in status_formats, in this order:
# nochanges,changes,read-only,append-ondly
set status_chars  = "IURA"
set status_format = " %r  %f %> %m ◢ %u:%d "

message-hook '!(~g|~G) ~b"^-----BEGIN\ PGP\ (SIGNED\ )?MESSAGE"' "exec check-traditional-pgp"

set index_format = "%Z  %D  %-20.20F  %s"
set date_format  = "%Y-%m-%d"              # date format display using ISO based date
set sort = threads                         # use threads base sort like gmail
set sort_aux = reverse-last-date-received  # last date in thrad is last mail, like gmail
set uncollapse_jump                        # don't collapse on an unread message
set sort_re                                # thread based on regex
set narrow_tree                            # save some spaces making tree narrow

# regexp to use find Re: emails
set reply_regexp = "^(([Rr][Ee]?(\[[0-9]+\])?: *)?(\[[^]]+\] *)?)*"

set pager_index_lines = 8 # number of index lines to show
set pager_context     = 4  # number of context lines to show
set pager_stop             # don't go to next message automatically
set menu_scroll            # scroll in menus
set pager_format = " %Z  %-20.20n: %s  %> %[!%Y-%m-%d %H:%M %Z] — %P ◢ %C: %m "
set tilde                  # show tildes like in vim
unset markers              # no ugly plus signs

# regextp to find quotations >...
set quote_regexp = "^( {0,4}[>|:#%]| {0,4}[a-z0-9]+[>|]+)+"

# prefer text/plain emails
alternative_order text/plain text/enriched text/html

ignore *   # ignore all headers
# show only these headers
unignore from: to: cc: bcc: date: list-unsubscribe: subject: tags:
unhdr_order * # some distros order things by default
# use this order for headers
hdr_order from: to: cc: bcc: date: list-unsubscribe: subject: tags:

set crypt_use_gpgme = yes
set pgp_autosign = yes

folder-hook ajdiaz.me/*        source ~/.mutt/accounts/ajdiaz.me

source ~/.mutt/accounts/ajdiaz.me
source ~/.mutt/colors

set nm_default_uri = "notmuch://$HOME/sys/mail"
set nm_query_type  = messages
set nm_record      = no
set nm_record_tags = "sent"

set wrap = 78
set sidebar_width = 35
set sidebar_visible = no
set sidebar_format = '%B%* %N'

macro index ,l "<enter-command>toggle sidebar_visible<enter><refresh>"

bind index D purge-message
bind pager D purge-message
macro pager L <pipe-entry>'urlview'<enter> 'Follow links with urlview'
macro index ,1 "<change-vfolder>ajdiaz.me/INBOX<enter>" "change accounts"
macro index ,x \
  "<tag-pattern>N<enter><tag-prefix><clear-flag>N<untag-pattern><enter>" \
  "mark all new as read"

# To avoid fast typing errors
macro generic ,q "<quit>"

# Analyze DMARC zip reports easily
macro attach ,dm '<shell-escape>rm -rf /tmp/.mutt-tmp/; mkdir /tmp/.mutt-tmp/<enter><save-entry>/tmp/.mutt-tmp/<enter>y<enter><shell-escape>cd /tmp/.mutt-tmp && 7z x *.zip && rm -f *.zip && ~/.mutt/dmarc-analysis | less -R<enter>'

# Some macros to search and expands threads with notmuch
macro index ,l \
  "<enter-command>unset wait_key<enter><shell-escape>notmuch-mutt --prompt search<enter><change-folder-readonly>~/.cache/notmuch/mutt/results<enter>"\
    "notmuch: search mail"

macro index ,h \
  "<enter-command>set my_old_pipe_decode=\$pipe_decode my_old_wait_key=\$wait_key nopipe_decode nowait_key<enter>\
  <pipe-message>notmuch-mutt thread<enter>\
  <change-folder-readonly>~/.cache/notmuch/mutt/results<enter>\
  <enter-command>set pipe_decode=\$my_old_pipe_decode wait_key=\$my_old_wait_key<enter>" \
    "notmuch: reconstruct thread"

# Some autoview orders
auto_view text/html
